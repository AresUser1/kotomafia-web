<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KotoMafia Control</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –¢–ï–ú–´ --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #999);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --divider: rgba(128,128,128, 0.15);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --radius: 16px;
        }

        body.dark-theme {
            --bg-color: #000000;
            --text-color: #ffffff;
            --hint-color: #8e8e93;
            --secondary-bg: #1c1c1e;
            --card-bg: #1c1c1e;
            --divider: rgba(255,255,255, 0.15);
        }

        body.light-theme {
            --bg-color: #f2f2f7;
            --text-color: #000000;
            --hint-color: #8e8e93;
            --secondary-bg: #ffffff;
            --card-bg: #ffffff;
        }

        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s, color 0.3s;
        }

        /* –ü–ö –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø */
        @media (min-width: 768px) {
            body {
                background-color: #1a1a1a; /* –§–æ–Ω –≤–æ–∫—Ä—É–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –ü–ö */
                display: flex; justify-content: center;
            }
            .app-wrapper {
                width: 100%; max-width: 480px;
                background-color: var(--bg-color);
                min-height: 100vh;
                box-shadow: 0 0 40px rgba(0,0,0,0.5);
                position: relative;
            }
            /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
            ::-webkit-scrollbar { width: 6px; }
            ::-webkit-scrollbar-track { background: transparent; }
            ::-webkit-scrollbar-thumb { background: var(--hint-color); border-radius: 3px; }
        }
        @media (max-width: 767px) { .app-wrapper { width: 100%; min-height: 100vh; } }

        .container {
            padding: 16px;
            padding-top: calc(16px + var(--safe-top));
            padding-bottom: calc(90px + var(--safe-bottom));
        }

        /* --- –•–ï–î–ï–† –ò –ü–û–ò–°–ö --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .title h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .title p { margin: 4px 0 0; color: var(--hint-color); font-size: 14px; }
        
        .theme-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: var(--card-bg); color: var(--text-color);
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.1s;
        }
        .theme-btn:active { transform: scale(0.9); }

        .search-box {
            position: sticky; top: var(--safe-top); z-index: 99;
            background: var(--bg-color); padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .search-input {
            width: 100%; padding: 12px 16px; border-radius: 14px; border: none;
            background: var(--secondary-bg); color: var(--text-color);
            font-size: 16px; outline: none; box-sizing: border-box;
        }
        .search-input::placeholder { color: var(--hint-color); }

        /* --- –°–ü–ò–°–û–ö –ß–ê–¢–û–í --- */
        .chat-list { list-style: none; padding: 0; margin: 0; }
        .chat-item {
            display: flex; align-items: center; background: var(--card-bg);
            padding: 12px; margin-bottom: 8px; border-radius: var(--radius);
            cursor: pointer; transition: transform 0.1s;
        }
        .chat-item:active { transform: scale(0.98); background: var(--secondary-bg); }
        .avatar {
            width: 48px; height: 48px; border-radius: 14px;
            background: linear-gradient(135deg, var(--button-color), #8ec5fc);
            color: #fff; font-size: 20px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            margin-right: 14px; flex-shrink: 0;
        }
        .info h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .info span { font-size: 13px; color: var(--hint-color); }
        
        .empty-state { text-align: center; color: var(--hint-color); margin-top: 40px; }

        /* --- –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö --- */
        .screen { display: none; animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        .nav-back {
            color: var(--button-color); font-weight: 600; font-size: 16px;
            cursor: pointer; margin-bottom: 16px; display: inline-flex; align-items: center;
        }
        .nav-back svg { fill: currentColor; width: 20px; height: 20px; margin-right: 4px; }

        /* –¢–ê–ë–´ */
        .tabs { display: flex; background: var(--secondary-bg); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .tab {
            flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600;
            border-radius: 10px; color: var(--hint-color); cursor: pointer; transition: 0.2s;
        }
        .tab.active { background: var(--card-bg); color: var(--text-color); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        .section { display: none; }
        .section.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–ê–†–¢–û–ß–ö–ò –ò –≠–õ–ï–ú–ï–ù–¢–´ */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
        .card-header { display: flex; justify-content: space-between; font-weight: 600; font-size: 15px; margin-bottom: 16px; }
        .counter { font-size: 13px; color: var(--button-color); background: rgba(36,129,204,0.1); padding: 2px 8px; border-radius: 8px; }

        /* –°–ï–¢–ö–ê –†–û–õ–ï–ô */
        .roles-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .role-card {
            background: var(--secondary-bg); border-radius: 12px; padding: 12px 6px;
            text-align: center; cursor: pointer; opacity: 0.6; filter: grayscale(100%);
            transition: all 0.2s; border: 2px solid transparent;
        }
        .role-card.active {
            background: var(--card-bg); border-color: var(--button-color); opacity: 1;
            filter: grayscale(0%); box-shadow: 0 4px 12px rgba(36,129,204,0.15); transform: translateY(-2px);
        }
        .role-icon { font-size: 28px; display: block; margin-bottom: 6px; }
        .role-name { font-size: 11px; font-weight: 700; line-height: 1.2; }

        /* –°–õ–ê–ô–î–ï–†–´ */
        .control-row { margin-bottom: 20px; }
        .control-row:last-child { margin-bottom: 0; }
        .row-label { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; }
        .row-val { font-weight: 700; color: var(--button-color); }
        input[type=range] { width: 100%; accent-color: var(--button-color); cursor: pointer; height: 6px; border-radius: 3px; }

        /* –¢–û–ì–ì–õ–´ */
        .toggle-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--divider); }
        .toggle-item:last-child { border-bottom: none; }
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e9e9ea; border-radius: 34px; transition: .3s;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px;
            background-color: white; border-radius: 50%; transition: .3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--button-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .dark-theme .slider { background-color: #363636; }

        /* –ü–õ–ê–í–ê–Æ–©–ê–Ø –ö–ù–û–ü–ö–ê (Desktop/Fallback) */
        .fab {
            position: fixed; bottom: calc(20px + var(--safe-bottom)); right: 20px;
            background: var(--button-color); color: #fff; padding: 14px 24px;
            border-radius: 30px; font-weight: 600; box-shadow: 0 4px 15px rgba(36,129,204,0.4);
            cursor: pointer; display: none; border: none; font-size: 16px; z-index: 100;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    </style>
</head>
<body>
<div class="app-wrapper">
    <div class="container">

        <div id="screen-chats" class="screen active">
            <div class="top-bar">
                <div class="title">
                    <h1>–í–∞—à–∏ —á–∞—Ç—ã</h1>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </div>
                <button class="theme-btn" onclick="toggleTheme()" id="themeIcon">üåì</button>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="search" placeholder="üîç –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã..." oninput="filterChats()">
            </div>

            <ul class="chat-list" id="chatList">
                </ul>
            <div id="emptyState" class="empty-state" style="display:none">–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>

        <div id="screen-settings" class="screen">
            <div class="nav-back" onclick="goBack()">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                –ù–∞–∑–∞–¥
            </div>

            <div class="title" style="text-align: center; margin-bottom: 20px;">
                <h1 id="chatTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                <p>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="setTab('roles')">üé≠ –†–æ–ª–∏</div>
                <div class="tab" onclick="setTab('timers')">‚è± –í—Ä–µ–º—è</div>
                <div class="tab" onclick="setTab('mech')">‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∫–∞</div>
            </div>

            <div id="sec-roles" class="section active">
                <div class="card">
                    <div class="card-header">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–ª–∏ <span class="counter" id="rolesCount">0</span></div>
                    <div class="roles-grid" id="rolesGrid"></div>
                </div>
            </div>

            <div id="sec-timers" class="section">
                <div class="card">
                    <div class="card-header">–û—Å–Ω–æ–≤–Ω—ã–µ</div>
                    <div class="control-row">
                        <div class="row-label"><span>–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤</span> <span class="row-val" id="d_max_players">12</span></div>
                        <input type="range" min="4" max="20" id="i_max_players" oninput="upd('max_players')">
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)</div>
                    <div class="control-row">
                        <div class="row-label"><span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span> <span class="row-val" id="d_reg_time">300</span></div>
                        <input type="range" min="60" max="600" step="30" id="i_reg_time" oninput="upd('reg_time')">
                    </div>
                    <div class="control-row">
                        <div class="row-label"><span>–ù–æ—á—å</span> <span class="row-val" id="d_night_time">60</span></div>
                        <input type="range" min="30" max="300" step="15" id="i_night_time" oninput="upd('night_time')">
                    </div>
                    <div class="control-row">
                        <div class="row-label"><span>–î–µ–Ω—å</span> <span class="row-val" id="d_day_time">60</span></div>
                        <input type="range" min="30" max="300" step="15" id="i_day_time" oninput="upd('day_time')">
                    </div>
                    <div class="control-row">
                        <div class="row-label"><span>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</span> <span class="row-val" id="d_vote_time">60</span></div>
                        <input type="range" min="30" max="300" step="15" id="i_vote_time" oninput="upd('vote_time')">
                    </div>
                </div>
            </div>

            <div id="sec-mech" class="section">
                <div class="card">
                    <div class="card-header">–ü—Ä–∞–≤–∏–ª–∞</div>
                    <div class="toggle-item">
                        <div>
                            <div style="font-weight:600">–°—Ç—Ä–æ–≥–∏–π —á–∞—Ç</div>
                            <div style="font-size:12px; color:var(--hint-color)">–£–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–æ—á—å—é/–º–µ—Ä—Ç–≤—ã—Ö</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="c_strict" onchange="markDirty()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <div>
                            <div style="font-weight:600">–†–∞–∑–¥–µ–ª—å–Ω—ã–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏</div>
                            <div style="font-size:12px; color:var(--hint-color)">–ö–æ–º —É–±–∏–≤–∞–µ—Ç, –°–µ—Ä–∂–∞–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="c_split" onchange="markDirty()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

        </div>

        <button class="fab" id="fab" onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- –î–ï–§–û–õ–¢–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò (–ï–°–õ–ò –ü–£–°–¢–û) ---
    const DEFAULTS = {
        max_players: 12, registration_time: 300, night_time: 60, day_time: 60, vote_time: 60,
        strict_chat_mode: false, split_duties: false,
        active_roles: {
            'doc': true, 'kom': true, 'sergeant': true, 'bodyguard': true, 
            'lyuba': true, 'nabludatel': true, 'hunter': true, 'grandma': false,
            'president': false, 'don': true, 'mafia': true, 'wife': true, 
            'lawyer': true, 'maniac': true, 'clown': true
        }
    };

    // --- –ú–ï–¢–ê–î–ê–ù–ù–´–ï –†–û–õ–ï–ô (–°–û–í–ü–ê–î–ê–Æ–¢ –° MODELS.PY) ---
    const ROLES = [
        {id: 'doc', icon: 'üöë', name: '–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä'},
        {id: 'kom', icon: 'üïµÔ∏è‚Äç‚ôÇÔ∏è', name: '–ö–æ—Ç-–ù—é—Ö–∞—á'},
        {id: 'sergeant', icon: 'üëÆ‚Äç‚ôÇÔ∏è', name: '–ö–æ—Ç-–°–µ—Ä–∂–∞–Ω—Ç'},
        {id: 'bodyguard', icon: 'üõ°', name: '–ö–æ—Ç-–û—Ö—Ä–∞–Ω–Ω–∏–∫'},
        {id: 'lyuba', icon: 'üíÉ', name: '–ú–∞—Ä—Ç–æ–≤—Å–∫–∞—è –ö–æ—à–∫–∞'},
        {id: 'nabludatel', icon: 'üëÄ', name: '–ì–ª–∞–∑–∞—Å—Ç—ã–π –ö–æ—Ç'},
        {id: 'hunter', icon: 'üî´', name: '–í–æ–æ—Ä—É–∂–µ–Ω–Ω—ã–π –ö–æ—Ç'},
        {id: 'grandma', icon: 'üëµ', name: '–ë–∞–±—É—à–∫–∞'},
        {id: 'president', icon: 'üßë‚Äçüíº', name: '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –ö–æ—Ç–æ–≤'},
        {id: 'don', icon: 'üé©', name: '–î–æ–Ω –ö–æ—Ç–ª–µ–æ–Ω–µ'},
        {id: 'mafia', icon: 'üî™', name: '–ë–∞–Ω–¥–∏—Ç'},
        {id: 'wife', icon: 'üíã', name: '–ö–æ—à–µ—á–∫–∞ –î–æ–Ω–∞'},
        {id: 'lawyer', icon: 'üíº', name: '–ê–¥–≤–æ–∫–æ—Ç'},
        {id: 'maniac', icon: 'ü™ì', name: '–î–∏–∫–∏–π –û–¥–∏–Ω–æ—á–∫–∞'},
        {id: 'clown', icon: 'ü§°', name: '–®—É—Ç–Ω–∏–∫'},
    ];

    // --- –î–ê–ù–ù–´–ï –û–¢ –ë–û–¢–ê ---
    // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±–æ—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —ç—Ç–æ –≤ URL –∏–ª–∏ initData
    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∞ "–∏–∑–≤–Ω–µ"
    let availableChats = []; 
    
    // –î–ï–ú–û –î–ê–ù–ù–´–ï (–ï—Å–ª–∏ –±–æ—Ç –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª, –¥–ª—è —Ç–µ—Å—Ç–∞)
    const DEMO_CHATS = [
        { id: 123, title: 'KotoMafia Dev', count: 5, settings: null },
        { id: 456, title: '–¢–µ—Å—Ç–æ–≤—ã–π –ß–∞—Ç', count: 12, settings: null },
        { id: 789, title: '–§–ª—É–¥–∏–ª–∫–∞ –ö–æ—Ç–∏–∫–æ–≤', count: 154, settings: null }
    ];

    let currentChatId = null;
    let settings = null;

    function init() {
        // 1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ URL (–µ—Å–ª–∏ –±–æ—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç JSON)
        const params = new URLSearchParams(window.location.search);
        const dataStr = params.get('data');
        
        if (dataStr) {
            try {
                availableChats = JSON.parse(decodeURIComponent(dataStr));
            } catch(e) { console.error('Error parsing data'); }
        }
        
        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –≥—Ä—É–∑–∏–º –¥–µ–º–æ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        if (availableChats.length === 0) {
            availableChats = DEMO_CHATS;
        }

        renderChats(availableChats);

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏
        tg.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏");
        tg.MainButton.onClick(saveData);

        // –¢–µ–º–∞
        if(tg.colorScheme === 'dark') document.body.classList.add('dark-theme');
        else document.body.classList.add('light-theme');
    }

    // --- –°–ü–ò–°–û–ö –ß–ê–¢–û–í ---
    function renderChats(list) {
        const ul = document.getElementById('chatList');
        const empty = document.getElementById('emptyState');
        ul.innerHTML = '';
        
        if(list.length === 0) {
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';

        list.forEach(chat => {
            const li = document.createElement('li');
            li.className = 'chat-item';
            li.onclick = () => openSettings(chat);
            const ava = chat.title.charAt(0).toUpperCase();
            li.innerHTML = `
                <div class="avatar">${ava}</div>
                <div class="info">
                    <h3>${chat.title}</h3>
                    <span>ID: ${chat.id} ‚Ä¢ ${chat.count} —É—á.</span>
                </div>
            `;
            ul.appendChild(li);
        });
    }

    function filterChats() {
        const q = document.getElementById('search').value.toLowerCase();
        const filtered = availableChats.filter(c => c.title.toLowerCase().includes(q));
        renderChats(filtered);
    }

    // --- –û–¢–ö–†–´–¢–ò–ï –ù–ê–°–¢–†–û–ï–ö ---
    function openSettings(chat) {
        currentChatId = chat.id;
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ –∏–ª–∏ –±–µ—Ä–µ–º –¥–µ—Ñ–æ–ª—Ç
        settings = JSON.parse(JSON.stringify(chat.settings || DEFAULTS));
        
        document.getElementById('chatTitle').innerText = chat.title;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        document.getElementById('screen-chats').classList.remove('active');
        document.getElementById('screen-settings').classList.add('active');
        window.scrollTo(0,0);

        fillUI();
        tg.HapticFeedback.selectionChanged();
    }

    function goBack() {
        currentChatId = null;
        tg.MainButton.hide();
        document.getElementById('fab').style.display = 'none';
        
        document.getElementById('screen-settings').classList.remove('active');
        document.getElementById('screen-chats').classList.add('active');
        tg.HapticFeedback.selectionChanged();
    }

    // --- –õ–û–ì–ò–ö–ê UI ---
    function fillUI() {
        const s = settings;
        
        // –†–æ–ª–∏
        const grid = document.getElementById('rolesGrid');
        grid.innerHTML = '';
        let activeC = 0;
        ROLES.forEach(r => {
            const isOn = s.active_roles[r.id];
            if(isOn) activeC++;
            const el = document.createElement('div');
            el.className = `role-card ${isOn ? 'active' : ''}`;
            el.onclick = () => toggleRole(r.id, el);
            el.innerHTML = `<span class="role-icon">${r.icon}</span><span class="role-name">${r.name}</span>`;
            grid.appendChild(el);
        });
        document.getElementById('rolesCount').innerText = activeC;

        // –°–ª–∞–π–¥–µ—Ä—ã
        setVal('max_players', s.max_players);
        setVal('reg_time', s.registration_time);
        setVal('night_time', s.night_time);
        setVal('day_time', s.day_time);
        setVal('vote_time', s.vote_time);

        // –ß–µ–∫–±–æ–∫—Å—ã
        document.getElementById('c_strict').checked = s.strict_chat_mode;
        document.getElementById('c_split').checked = s.split_duties;
    }

    function setTab(name) {
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        
        const idx = name === 'roles' ? 0 : name === 'timers' ? 1 : 2;
        document.querySelectorAll('.tab')[idx].classList.add('active');
        document.getElementById(`sec-${name}`).classList.add('active');
        tg.HapticFeedback.selectionChanged();
    }

    function toggleRole(id, el) {
        const isActive = el.classList.contains('active');
        el.classList.toggle('active');
        settings.active_roles[id] = !isActive;
        
        if(!isActive) tg.HapticFeedback.impactOccurred('light');
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
        const count = Object.values(settings.active_roles).filter(Boolean).length;
        document.getElementById('rolesCount').innerText = count;
        markDirty();
    }

    function setVal(k, v) {
        document.getElementById(`i_${k}`).value = v;
        document.getElementById(`d_${k}`).innerText = v;
    }

    function upd(k) {
        const v = parseInt(document.getElementById(`i_${k}`).value);
        document.getElementById(`d_${k}`).innerText = v;
        settings[k] = v;
        markDirty();
    }

    function markDirty() {
        settings.strict_chat_mode = document.getElementById('c_strict').checked;
        settings.split_duties = document.getElementById('c_split').checked;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        tg.MainButton.show();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º FAB —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –≤ —É–∑–∫–æ–º –æ–∫–Ω–µ (—Ö–æ—Ç—è —Å—Ç–∏–ª–∏ —Å–∞–º–∏ —Å–ø—Ä–∞–≤—è—Ç—Å—è)
        document.getElementById('fab').style.display = 'block';
    }

    function saveData() {
        if(!currentChatId) return;
        tg.MainButton.showProgress();
        
        const payload = { chat_id: currentChatId, settings: settings };
        tg.sendData(JSON.stringify(payload));
        
        // –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        setTimeout(() => { 
            tg.MainButton.hideProgress(); 
            tg.close();
        }, 300);
    }

    function toggleTheme() {
        const b = document.body;
        const icon = document.getElementById('themeIcon');
        if(b.classList.contains('dark-theme')) {
            b.classList.replace('dark-theme', 'light-theme');
            icon.innerText = 'üåë';
        } else {
            b.classList.replace('light-theme', 'dark-theme');
            icon.innerText = '‚òÄÔ∏è';
        }
        tg.HapticFeedback.impactOccurred('medium');
    }

    init();
</script>
</body>
</html>